<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyLogSIEM - Live Dashboard</title>
    <!-- Use Tailwind CSS for easy, modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Simple style for new alerts */
        .alert-new {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans">

    <div class="container mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-emerald-400">PyLogSIEM</h1>
            <div>
                <span class="text-xs font-medium mr-2">Status:</span>
                <span id="status-indicator" class="inline-block w-3 h-3 bg-red-500 rounded-full" title="Disconnected"></span>
            </div>
        </header>

        <main>
            <div class="bg-gray-800 shadow-lg rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">Live Alert Feed</h2>
                <!-- This is where our alerts will be injected by JavaScript -->
                <div id="alert-feed">
                    <p class="text-gray-500 italic">Connecting to alert stream... no new alerts.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- 
      - 1. Import the Socket.IO client library 
      - We need this for the JavaScript socket.io object
    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    
    <script>
        // Wait for the document to be fully loaded
        document.addEventListener('DOMContentLoaded', (event) => {
            
            // 2. Connect to our server's WebSocket
            // This URL will connect to the same host and port the page was served from
            const socket = io();

            const statusIndicator = document.getElementById('status-indicator');
            const alertFeed = document.getElementById('alert-feed');

            // 3. Handle built-in "connect" event
            socket.on('connect', () => {
                console.log('Successfully connected to server!');
                statusIndicator.classList.remove('bg-red-500');
                statusIndicator.classList.add('bg-green-500');
                statusIndicator.title = 'Connected';
                
                // Clear the default "connecting" message
                if (alertFeed.querySelector('p')) {
                    alertFeed.innerHTML = '<p class="text-gray-500 italic">Waiting for new alerts...</p>';
                }
            });

            // 4. Handle built-in "disconnect" event
            socket.on('disconnect', () => {
                console.log('Disconnected from server.');
                statusIndicator.classList.remove('bg-green-500');
                statusIndicator.classList.add('bg-red-500');
                statusIndicator.title = 'Disconnected';
            });

            // 5. Handle our *custom* "new_alert" event
            // This is the most important part!
            // The server will 'emit' this event when a rule is triggered.
            socket.on('new_alert', (alert) => {
                console.log('Received new alert:', alert);

                // Clear the "waiting" message if it's still there
                if (alertFeed.querySelector('p')) {
                    alertFeed.innerHTML = '';
                }

                // Create a new HTML element for the alert
                const alertElement = document.createElement('div');
                alertElement.className = 'bg-gray-700 p-4 rounded-md mb-3 shadow alert-new';
                alertElement.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-lg ${alert.level_color}">${alert.rule_name}</span>
                        <span class="text-sm text-gray-400">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <p class="text-gray-300">${alert.description}</p>
                `;
                
                // Add the new alert to the top of the feed
                alertFeed.prepend(alertElement);
            });
        });
    </script>
</body>
</html>
